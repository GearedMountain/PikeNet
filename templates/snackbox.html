<html>
	<link rel="stylesheet" href="styles/style.css">

	<style>
		#overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background-color: black;
			animation: dissolve 5s ease-out forwards;
		}

		/* Dissolve effect */
		@keyframes dissolve {
			0% { opacity: 1; }
			80%	{ opacity: 1; }
			100% { opacity: 0; }
		}

		#loading{
			position: fixed;
			height: 100%;
			width: 100%;
			top:0px;
			background-color: black;
			color:white;
			vertical-align: middle;
		}
		#snackPhoto{
			width:70vw;
			height:70vw;
			padding-left:2.5vw;
			
 			margin: auto;
		}

		.hidden{
			display:none important!;
		}

		.block{
			display: block;
		}
	</style>
	<!--<div id="overlay" class="center" style="align-items: center;">
		<h1>Columbia</h1>
		<img src="images/flag.png">
	</div>-->
	<body>
		<h2 id="myName"> Snackbox </h2>		
		<div id="finalResult">

		</div>
		<div id="main-gui">
			<div class="left-column">
				<img id="snackPhoto" class="hidden">
				<h1 id="selectedSnack">Select a Snack</h1>
				<h1 class="hidden" id="SnackScoreParent">Score: <span id="SnackScore">0</span></h1>
				<div id="messageList">

				</div>
				<div id="snacklist" class="center">
				</div>
			</div>
			<div class="right-column" id="right-column">
			
			</div>

		</div>
		<div class="center hidden" id="NextSnackButton"><button onclick="NextSnack()">Start Next Snack</button></div>
		<div id="loading">
			<h1 style="position:fixed;top:45%;vertical-align: middle;">Loading...</h1>
		</div>

	</body>	

	<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
	
	<script>
		//var socket = io.connect("https://thepikenet.com");
		var ratedThisSnack = false;
		var myName = ""
		var socket = io.connect();

		const playerlist = document.getElementById('playerlist');

		const snacklist = document.getElementById('snacklist');
		
		function AddSnackLocal(SnackName, SnackID){
			SnackCount += 1;
			const newSnack = document.createElement('button');
			newSnack.id = "snack-" + SnackID;
			newSnack.innerHTML = SnackName;
			/*newSnack.addEventListener('change', function() {
				UpdateSnack(newSnack.id.split("-")[1], newSnack.value)
			});*/
			newSnack.addEventListener("click", function() {
    			SnackSelected(newSnack.id.split("-")[1]);
			});
			snacklist.appendChild(newSnack);
		}

		let availableRatings = []
		socket.on('update_available_ratings', function(data) {
			document.getElementById('right-column');
			//availableRatings = JSON.parse(data.availableRating)
			console.log("ratings : " + data["availableRatings"])

			document.getElementById("right-column").innerHTML = '';
			data["availableRatings"].forEach(function(item) {
				if(item !== 0)
				{
					let RatingButton = document.createElement("button");
					RatingButton.textContent = item;
					RatingButton.classList.add("rating-button");
					RatingButton.addEventListener("click", function() {
						//alert("Snack rated!");
						if(!ratedThisSnack){
							HideRatings()
							socket.emit('snack_rated', { rating:RatingButton.textContent });
							ratedThisSnack = true;
						}
					});
					document.getElementById("right-column").appendChild(RatingButton);
				}
			});
		})
		socket.on('update_snacklist', function(data) {
			console.log(data)
			snacklist.innerHTML = '';
			SnackCount = 0;
			Object.entries(data).forEach(([key, value]) => {
				AddSnackLocal(value, key)
			});
			console.log(SnackCount)
			try{
				document.getElementById("loading").remove();
			}
			catch{

			}
			
		});
		
		socket.on('snack_selected_server', function(data) {
				SnackSelectedLocal(data.snackSelected)
				document.getElementById("snackPhoto").classList.remove('hidden')
				document.getElementById("snackPhoto").classList.add('block')

				let img = new Image(); // Create image element dynamically
				img.src = `/image/${data.snackSelected}`; 
				document.getElementById("snackPhoto").src = "/images/loading.gif"

				img.onload = function() {
					document.getElementById("snackPhoto").src = `/image/${data.snackSelected}`// Add to the page only after loading
					document.getElementById("snackPhoto").classList.remove('hidden')
					document.getElementById("snackPhoto").classList.add('block')


					console.log("Image fully loaded!");
				}

				// If the image doesnt exist, remove the loading sign too
				img.onerror = function() {
        			console.log("Image failed to load.");
					document.getElementById("snackPhoto").src = ""
					document.getElementById("snackPhoto").classList.add('hidden')
					document.getElementById("snackPhoto").classList.add('remove')

    			};
				ratedThisSnack = false;
		});

		socket.on('update_rating_logs', function(data) {
			var snackScore = 0
			document.getElementById("messageList").innerHTML = ""
			Object.entries(data).forEach(([key, value]) => {
				if(key == myName)
				{
					console.log("already rated this")
					document.getElementById("main-gui").classList.remove("expanded");
				}
				snackScore += parseInt(value[1])
				AddLogLocal(key + " rated " + value[0] + " a " + value[1], snackScore)
				console.log(key + " rated " + value[0] + " a " + value[1]) 
			});

		});
		
		socket.on('whats_my_name', function(data) {
				console.log("my name: " + data)	
				myName = data
				document.getElementById("myName").innerHTML = myName + "'s visit to Columbia"
		});
		
		socket.on('snack_rated_server', function(data) {
				AddLogLocal(data.message, data.snacksRating)
		});
		socket.on('all_players_voted', function(data) {
				document.getElementById("NextSnackButton").classList.remove('hidden')
		});

		function AddLogLocal(message, snackScore){
				document.getElementById("SnackScore").innerHTML = snackScore
				let MessageList = document.getElementById("messageList")
				let RatingMessage = document.createElement("h2");
				RatingMessage.innerHTML = message;
				MessageList.appendChild(RatingMessage)
		}

		function ShowRatings() {
    		document.getElementById("main-gui").classList.add("expanded");
			
		}	

		function HideRatings() {
    		document.getElementById("main-gui").classList.remove("expanded");
		}

		function SnackSelectedLocal(selected){
			document.getElementById("selectedSnack").innerHTML = selected;
			document.getElementById("snacklist").classList.add("hidden");
			document.getElementById("SnackScoreParent").classList.remove("hidden");
			document.getElementById("SnackScore").innerHTML = "0";
			ShowRatings()
		}

		socket.on('next_snack_server', function(data) {
			document.getElementById("snacklist").classList.remove("hidden");
			document.getElementById("SnackScoreParent").classList.add("hidden");
		    document.getElementById("messageList").innerHTML = ""
			document.getElementById("NextSnackButton").classList.add('hidden')
			document.getElementById("selectedSnack").innerHTML = "Select a Snack"
			document.getElementById("snackPhoto").classList.add('hidden')
			document.getElementById("snackPhoto").classList.remove('block')

		});

		socket.on('snacks_finished', function(data) {
			document.getElementById("selectedSnack").classList.add('hidden');
			document.getElementById("messageList").innerHTML = ""
			Object.entries(data).forEach(([key, value]) => {
				FinalResults(key, value)
			});
			
		});

		function FinalResults(name, score){
			const result = document.createElement('h2');
			document.getElementById("NextSnackButton").classList.add('hidden')
			result.innerHTML = name + " : " + score;
			document.getElementById("finalResult").appendChild(result)

		}

		function NextSnack(){
			document.getElementById("SnackScoreParent").classList.add("hidden");
			socket.emit('next_snack', {data:true});

		}

		function SnackSelected(ID){
			socket.emit('snack_selected', { id:ID });
		}

		
	</script>
</html>
